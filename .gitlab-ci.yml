stages:
  - check
  - build
  - e2e
  - docker

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PNPM_STORE_DIR: "$CI_PROJECT_DIR/.cache/pnpm"

# ─── Backend ────────────────────────────────────

backend:check:
  stage: check
  image: python:3.12-slim
  cache:
    key: backend-pip
    paths:
      - .cache/pip
  before_script:
    - cd backend
    - pip install -r requirements.txt -q
  script:
    - python -c "from app.config import settings; from app.routers import problems, sessions, execution, interview, scoring; print('All imports OK')"
    - |
      python -c "
      import json, pathlib
      index = json.loads(pathlib.Path('data/problems/problem_index.json').read_text())
      for p in index['problems']:
          fp = pathlib.Path('data/problems') / p['file']
          data = json.loads(fp.read_text())
          assert data['id'] == p['id'], f'ID mismatch: {p[\"id\"]}'
          assert data['category'] in ('algorithms','fastapi','django','pytest'), f'Bad category: {data[\"category\"]}'
          assert data['difficulty'] in ('easy','medium','hard'), f'Bad difficulty: {data[\"difficulty\"]}'
          assert len(data['test_cases']) > 0, f'No test cases: {p[\"id\"]}'
      print(f'Validated {len(index[\"problems\"])} problems')
      "

# ─── Frontend ───────────────────────────────────

frontend:build:
  stage: build
  image: node:22-slim
  cache:
    key: frontend-pnpm
    paths:
      - .cache/pnpm
      - frontend/node_modules
  before_script:
    - corepack enable && corepack prepare pnpm@latest --activate
    - cd frontend
    - pnpm install
  script:
    - pnpm build

# ─── E2E Tests ─────────────────────────────────

e2e:playwright:
  stage: e2e
  image: docker:27
  services:
    - docker:27-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  needs:
    - backend:check
    - frontend:build
  before_script:
    - cp backend/.env.example backend/.env
    - docker compose up --build -d
    - |
      echo "Waiting for services..."
      for i in $(seq 1 30); do
        if docker compose exec -T backend python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health')" 2>/dev/null; then
          echo "Backend ready"
          break
        fi
        sleep 2
      done
  script:
    - docker compose exec -T frontend pnpm exec playwright install --with-deps chromium
    - docker compose exec -T -e CI=true -e BASE_URL=http://localhost:5173 frontend pnpm test:e2e
  after_script:
    - docker compose down
  artifacts:
    when: on_failure
    paths:
      - frontend/test-results/
    expire_in: 7 days

# ─── Docker ─────────────────────────────────────

docker:build:
  stage: docker
  image: docker:27
  services:
    - docker:27-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  needs:
    - backend:check
    - frontend:build
  before_script:
    - cp backend/.env.example backend/.env
  script:
    - docker compose build
